---
title: "Code R & Graphiques Dalma"
author: "Paul Géraud, Armand Eyraud, Thomas Bullimore, Tony Liu"
date: "5 mars 2024"
output:
  html_document:
    theme: flatly
    highlight: pygments
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,results='hide',warning=FALSE,message=FALSE}
#install.packages("tidyverse")
#install.packages("lubridate")
#install.packages("plotly")

library(tidyverse)
library(lubridate)
library(plotly)
library(corrplot)
library(e1071)
```

-   **tidyverse**, utilisé pour manipuler les données et réaliser des graphiques plus esthétiques que ceux proposés par R de base.
-   **lubridate**, permet de manipuler plus facilement les dates.
-   **plotly**, permet de rendre des graphiques interactifs.

# IMPORTATION DES DONNEES

Importation des données
```{r}
auto=read.csv("auto.csv",sep=";")
```

Ce jeu de données est constitué de 10 496 individus ainsi que de 17 variables. Voici le détail de ces dernières variables:  

* **PERMIS: **Ancienneté du permis en nombre de mois
* **ACV: **L'ancienneté du véhicule en nombre d'années. Il est important de noter que cette variable est **censurée à droite**: les véhicules ayant une ancienneté supérieure ou égal à 10 ans sont rapportés à 10 ans.
* **SEX: **Sexe du conducteur.
* **STATUT: **Indique si le conducteur est célibataire ou autre.
* **CSP: **Nombre permettant d'identifier les catégories socioprofessionelles. La signification des nombres est disponible [ici](https://www.ast74.fr/upload/administratif/liste-des-codes-csp-copie.pdf).
* **USAGE: ** Variable permettant d'identifier l'utilité du véhicule.
* **AGECOND: ** Age du conducteur.
* **K8000: ** Indique si l'option de kilométrage limité est activé.
* **RM: ** Indique la présence d'un bonus ou d'un malus.
* **CAR: ** Type de véhicule.
* **CLA: ** Classe SRA. C'est un indice qui est fonction du prix neuf TTC du véhicule.
* **ALI: ** Indique le type de carburant utilisé.
* **ENE: ** Distingue voitures électriques, à essence et diesel.
* **VIT: ** Tranche d'appartenance de la vitesse de pointe du véhicule. A noter que la catégorie *S220* indique les véhicules pouvant aller au delà de 220km/h, il y a donc une **censure à droite**.
* **SEGM: ** Indique la segmentation du véhicule (catégorise les véhicules).
* **GARAGE: ** Caractérise le garage ou est rangé la voiture.
* **CHARGE: ** Montant de la sinistralité au cours de l'année en euros.

# VISUALISATION

![21 premières lignes](ExtraitDataset.png)
On peut observer la censure à droite pour la varriable ancienneté. On remarque également que beaucoup de personnes ont une charge de sinistre égale à 0. On en déduit que ces individus n'ont pas eu de sinistres. On peut donc supposer que cette base de donnée est une base recensant tous les clients au cours d'une année (et pas uniquement ceux qui ont eu un sinistre).

# CONVERSION DES DONNEES

Regardons le type des données
```{r}
sapply(auto,typeof)
```
Le type des données est correct. Cependant nous allons changer le type des variables *SEX,CSP,USAGE,K8000,CAR,CLA,ALI,ENE,VIT,SEGM,GARAGE* en variable catéogoriques. Cela permettrat de faciliter la manipulation de ces variables plus tard, notamment pour les GLM.
```{r}
auto=auto%>%
  mutate(CSP=as.factor(CSP),USAGE=as.factor(USAGE),K8000=as.factor(K8000),CAR=as.factor(CAR),CLA=as.factor(CLA),ALI=as.factor(ALI),
         ENE=as.factor(ENE),VIT=as.factor(VIT),SEGM=as.factor(SEGM),GARAGE=as.factor(GARAGE),SEX=as.factor(SEX))

#vérification
sapply(auto,typeof)
```

# STATISTIQUES DESCRIPTIVES

Ancienneté du permis
```{r}
summary(auto$PERMIS)
cat("Ecart type: ",sd(auto$PERMIS))
hist(auto$PERMIS)
boxplot(auto$PERMIS)
```

Distribution du sexe
```{r}
barplot(table(auto$SEX))
```
Age du conducteur
```{r}
summary(auto$AGECOND)
cat("Ecart type: ",sd(auto$AGECOND))
hist(auto$AGECOND)
boxplot(auto$AGECOND)
```
Ancienneté du véhicule
```{r}
summary(auto$ACV)
cat("Ecart type: ",sd(auto$ACV))
hist(auto$ACV)
boxplot(auto$ACV)
```


On peut facilement observer la censure à droite sur ce graphique avec la sureprésentation des 10.  

Répartition des différentes catégories de véhicules: 
```{r}
barplot(table(auto$CAR),las=2)
```
Il y a principalement des berlines.  

Classe des véhicules:

```{r}
barplot(table(auto$CLA),las=2)
```

Sinistralité
```{r}
summary(auto$CHARGE)
cat("Ecart type: ",sd(auto$CHARGE))
hist(auto$CHARGE)
boxplot(auto$CHARGE)
```
On observe très clairement que l'écrasante majorité des assurés n'ont pas eu de sinistres au cours de l'année. L'écart type est conséquent, suggérant une forte dispersion probablement entrainé par la présence de valeurs extrêmes. Cela est observable sur l'hisogramme. Recherchons le quantile limite à partir duquel il y a des sinistres:
```{r}
p=seq(from=0.75,to=0.995,by=0.005)
q=quantile(auto$CHARGE,p)
vitesse=q[-1] / q[-length(q)] 
print(q)
plot(p,q,type="l")
print(vitesse)
plot(p[-1],vitesse)
```
On observe donc que 86% des assurés n'ont pas eu sinistre au cours de l'année. Au delà de 87%, le montant des sinistres semblent augmenter très rapidement.
Si on regarde la vitesse à laquelle les quantiles augmentent (rapport entre un quantile et le quantile précédent), on à un rapport plus ou moins constant de 1.2. Cela confirme donc que la croissance est simmilaire à une suite géométrique de raison >1, cela confirme notre hypothèse de forte croissance. Enfin, il ne faut pas oublier que même le quantile à 99.5% est très éloigné du maximum.  
Statistiques avancées:
```{r}
cat("Skewness: ",skewness(auto$CHARGE))
cat("\nKurtosis: ",kurtosis(auto$CHARGE))
```
L'asymétrie est positive, ce qui indique que la majorité des sinistres se trouvent à gauche. Ce résultat était prévisible car on pouvait observer que la médiane était inférieure à la moyenne.  
Le kurtosis est positif, ce qui suggère la présence de *leptokurtic* et donc la présence d'une queue de distribution épaisse, ce qui était aussi attendu après l'analyse des quantiles.  
Nous allons maintenant refaire les mêmes analyses mais uniquement sur la population qui a eu des sinistres pour avoir une meilleure idée de la sinistralitée :
```{r}
OnlySinistre=auto%>%
  filter(CHARGE>0)
summary(OnlySinistre$CHARGE)
cat("Ecart type: ",sd(OnlySinistre$CHARGE))
hist(OnlySinistre$CHARGE)
boxplot(OnlySinistre$CHARGE)
```
```{r}
p=seq(from=0.01,to=0.99,by=0.01)
q=quantile(OnlySinistre$CHARGE,p)
vitesse=q[-1] / q[-length(q)] 
print(q)
plot(p,q,type="l")
print(vitesse)
plot(p[-1],vitesse)
```
```{r}
cat("Skewness: ",skewness(OnlySinistre$CHARGE))
cat("\nKurtosis: ",kurtosis(OnlySinistre$CHARGE))
```
On retrouve au final des résultats plus étalés mais avec une dynamique similaire, avec toujours la vitesse de croissance qui est à peu près constante. Parmis les quantiles intéressants à citer, on peut noter:  

* 6% des sinistres ont un montant inférieur à 100€
* 51% (grosso modo la sinistralité médianne) des sinistres ont un montant inférieur à 1000€
* 75% des sinistres sont en dessous de 2000€
* Un peu moins de 2% des sinistres sont au dessus de 10000€.

## Corrélations entre les variables

Pour les corrélations, on ne va comparer que les variables continues (sinon la corrélation n'a pas vraiment de sens):
```{r}
VarContinues=auto%>%
  select(PERMIS,AGECOND,ACV,RM,CHARGE)
matCorrel=cor(VarContinues)
corrplot(matCorrel,
         method = "color")
```
On remarque que l'ancienneté du permis est fortement positivement corrélé à l'âge du conducteur (ce qui est logique). On a une lègère corrélation négative entre l'ancienneté de la voiture et du permis. Cela pourrait suggérer que les jeunes sont plus enclins à utiliser de vieilles voitures et vice versa (résultat à prendre avec des pincettes, la corrélation est faible). Concernant les corrélations avec le montant de la sinistralité, la légère corrélation négative entre la charge du sinistre et l'ancienneté. Cela était plutôt prévisible, si une voiture est ancienne, l'indemnisation en cas d'accident sera souvent moindre.  
C'est plutôt décevant comme ceci car par grand chose à en tirer pour le montant de la sinistralité. Refaisons le même graphe mais uniquement pour les personnes dans le portefeuille qui ont eu des sinistres.  
```{r}
VarContinues2=OnlySinistre%>%
  select(PERMIS,AGECOND,ACV,RM,CHARGE)
matCorrel2=cor(VarContinues2)
corrplot(matCorrel2,
         method = "color")
```
On retrouve exactement les mêmes dispositions. Il n'y a donc pas grand chose à en tirer dans l'état actuel.  

# Regroupement des modalités

Le dataset contient beaucoup de variables catégoriques, cependant, certaines catégories peuvent être trop fines et on aimerait pouvoir regrouper les individus qui se ressemblent. Parmi ces regroupements possibles:  

* La variable **CSP** : On va chercher à regrouper les individus selon qu'ils exercent un corps de métier similaire (*exemple : employé de bureau, ouvrier, agriculteur, etc..*).  
* La variable **CAR** : On peut regrouper les véhicules dans des catégories similaires (*exemple : poids lourds, sportives,familiale,etc...* ).  
* La variable **CLA** : Il y a 26 catégories. Ce n'est pas forcément nécessaire d'en avoir autant. Regrouper les catégories similaires peut être suffisant.  

Faisons cela:
```{r}
auto_Modal=auto%>%
  mutate(CSP=case_when(
    substr(CSP,1,1)=="1"~"Agriculteur",
    substr(CSP,1,1)=="2"~"Artisans, Commerçants & Chef entreprise",
    substr(CSP,1,1)=="3"~"Cadres",
    substr(CSP,1,1)=="4"~"Intérimaire et techniciens",
    substr(CSP,1,1)=="5"~"Employés",
    substr(CSP,1,1)=="6"~"Ouvriers",
  ),CATEGORIE=case_when(
    CAR %in% c("BER","BRK","MSPF","MSPHF")~"Familiale",
    CAR %in% c("CAB","CPE","TT")~"Sportif & TT",
    CAR %in% c("BUS","CTE")~"Poids lourds"
  ),CLASSE=case_when(
    CLA %in% c("A","B","C","D","E")~1,
    CLA %in% c("F","G","H","I","J")~2,
    CLA %in% c("K","L","M","N","O")~3,
    CLA %in% c("P","Q","R","S","T")~4,
    CLA %in% c("U","V","W","X","Y","Z")~5
  ))%>%
  select(-CAR,-CLA)
```


```{r}
barplot(table(auto_Modal$CLASSE),las=2)
```
